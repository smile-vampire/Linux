## 服务端框架

**一、为什么做这个项目：**

​		学习完Linux后，对系统编程和网络编程比较感兴趣，也算是对知识的整合与运用，以后从事后台开发也会更加清晰。就产生了写一个后端服务器框架的想法。

**二、项目原理及流程：**

​		服务器框架采用了多进程的服务器模型；master做管理，worker提供服务，分工明确；避免了某一线程挂了，导致整个服务器挂了；也可以充分利用处理器的并发能力；可以完成进程在固定处理器上的绑定，某种意义实现了负载均衡。

​		服务器框架主要分为三大部分。

​		Ⅰ、第一部分为网络层，进行数据收发，采用多路转接epoll进行事件监控。

​		Ⅱ、第二部分为业务层，进行解析数据、处理数据、封装数据，采用线程池。

​		Ⅲ、第三部分为数据库访问层，访问数据库，进行操作，采用连接池。

**1.配置文件：**配置文件格式为key=value形式，#、[、; 都认为是注释；读取配置项有两种格式，一种是字符串，另一种是数字。将key-value信息读取到内存当中，一上来定义全局变量（链表）抓住所有的配置信息。

**2.环境变量搬家：**由于每个进程的名字不一样，需要修改名字，可能名字很长，用户使用，不能保证它传的命令行参数不会超过了argv，为了安全；把原本的环境变量搬走。从堆内存分配一块空间把原本的空间分过来。最后将给的新名字设置到命令行参数。

**3.信号处理：**信号值、信号名字、发送的信号名字、信号对应的处理函数。放到结构体中，定义一个结构体数组将所有信号信息放入其中。

**4.创建进程：**在创建子进程之前需要屏蔽掉信号，避免在创建子进程期间被打断。父进程阻塞，可以被信号打断，直到有信号来唤醒。可能需要重启子进程或者重新加载配置文件等，所以用到sigsupend函数，进行信号屏蔽暂停功能。创建子进程对子进程进行初始化和设置子进程进程标题。子进程初始化中需要接解除信号屏蔽。设置CPU亲缘，sched_setaffinity().把哪个进程邦定到那个cpu上。

**5.创建线程池：**如果大量请求过来需要创建线程，但是线程是有限的，需要用线程池来进行处理业务；

任务队列+线程，任务队列放入回调函数，参数以及任务节点，线程池放入互斥锁、条件变量、任务队列队头和队尾，线程池中线程最大创建数量、当前线程数量以及空闲线程数量、是否销毁标志。

​	Ⅰ、初始化线程池

​	Ⅱ、线程池添加任务

​		①、线程池线程动态增长，将task放入任务队列，如果有空闲线程，就直接回调这个任务；如果没有空闲线程，并且线程数量没有到达最大线程创建数量则创建线程来执行任务；如果没有空闲线程并且到达了最大线程数量则只能等待。

​		②、动态开辟任务节点，memset进行清空，将节点给任务队列放时，因为有的节点需要取，有的需要放，所以进行加锁操作。放入后，如果线程池有空闲线程，这个空闲线程一定在pthread_cond_wait等待需要唤醒线程执行任务，如果说pool->head==NULL && quit==0,进行阻塞等待；
从任务接待你取出任务进行执行；调用callback执行可能时间比较长，可以给他解锁，不解锁
线程池只有一个线程执行任务，如果时间很长会影响其他线程去执行任务。之前上锁时怕生产者和消费者都去操纵他，而现在将他从任务队列当中取出来了，就不怕了；当处理完成将任务节点free掉，他是动态开辟的。

​	Ⅲ、销毁线程池

​		在销毁时将quit标志置位1，销毁线程池，但是不能立即进行销毁，可能任务队列还有任务，需要将任务执行完成才能退出。退出前空闲线程大于0去通知，pthread_cond_brodcast。通知完成在外面进行pthread_cond_wait进行等待，直到所有线程退出，才离开。

**6.网络层进行数据收发多路转接epoll+连接池**

​	网络层将需要将文件描述符和数据都给线程池，用到epoll返回时结构体当中有epoll_event结构体体，就知道到底是EPOLLIN还是EPOLLOUT，有epoll_data当中ptr，可以返回ptr，fd只能带回文件描述符，ptr回调带更多东西，可以装fd也可以装回调函数，这样可以指导文件描述符，也可以直到对应文件描述符回调哪个函数。原因就是在网络层和线程池之间，网络层负责数据接收，两者之间都需要知道那个描述符，线程池需要知道是哪个已连接套接字的，网络将文件描述符以及数据要传给线程池，处理读还是处理写；最后返回时也要告诉网络层是哪个。

​	连接池：已连接套接字，当前状态是EPOLLIN还是EPOLLOUT，以及都回调函数和写回调函数，还有缓冲区。连接池节点信息。

​	Ⅰ、初始化监听套接字

​		创建套接字、绑定地址信息、监听连接

​	Ⅱ、初始化epoll

​		①、创建epoll操作句柄

​		②、初始化线程池

​		③、初始化连接池

​		④、从连接池获取一个空闲连接，取连接池头结点。

​		⑤、关闭一个连接，关闭对应文件描述符，归还连接池节点。

​		⑥、需要给监听套接字分配连接池节点

​		⑦、监听套接字对应的回调函数（接收连接，得到新的套接字描述符，也需要将新的套接字描述符添加至连接池，分配连接池，进行监控读回调函数和写回调函数）

​		⑧、需要将该套接字挂到红黑树上，把那一个文件描述符，以读还是写挂到红黑树上。

​		⑨、新创建的套接字读写监控：可能修改；如果是修改，先将它进行删除，再进行添加，如果修改前是EPOLLIN修改成EPOLLOUT，反之则相反。其它判断是读还是写。

​	Ⅲ、获取发生事件

​		①、epoll_wait进行事件监控，如果返回要么是监听套接字就绪，要么是新创建的套接字就绪，获取事件类型，执行对应的回调函数。

​		②、数据读取到，并且装到了buffer中，将任务放到线程池中去处理。处理完成后还是EPOLLIN状态，要进行发送数据，需要改变状态，MOD。如果对方关闭，从红黑树删除，归还连接池节点。

​		③、写数据：处理完事件后，才加入到epoll写事件上去，让epoll帮我们去监控写事件，如果数据一读，立马去监控写事件，如果内核缓存有空间立马出发epoll_wait返回，而这时候数据没有处理好，会不断触发epoll_wait返回;第二个方案，当数据处理完成直接发送数据，如果一次发送不玩，再将它加入到红黑树中。

**7.数据库连接池**

​	为了减少三次握手，四次挥手；减少数据库的权限检查；规定最多有多少个线程和数据库打交道

​		Ⅰ、连接数据库

​			①、初始化操作句柄

​			②、连接数据库

​		Ⅱ、插入，删除

​		Ⅲ、数据库查询

​	**连接池：**

​		连接池结构体；用户名、密码、数据库最多连接、当前连接、同步互斥、连接节点、队头队尾。

​		Ⅰ、连接池初始化

​		Ⅱ、向连接池添加任务

​			如果连接池有空闲线程则执行；如果没有并且小于最大创建线程数量，则进行创建连接；否则只能等待。有空闲连接，取下连接节点执行任务，执行完成放回连接池。如果创建，则直接执行任务，执行完毕放回连接池。



​	**三、项目亮点**

​		1.CPU的亲缘绑定，充分利用多核特性

​		2.多进程架构，任何子进程挂掉不会影响其他子进程

​		3.事件驱动模型高并发比较好

​		4.业务层采用线程池、连接数据库采用连接池避免大量开销

**四、项目优化**

​		1.可以在线程池提供最少10个线程启动，动态进行增长，动态销毁，销毁也保留10个

​		2.进行超时处理，如果线程池线程长时间没有执行任务可以将其销毁

​		3.网络层和线程池之间的连接池读取数据在buffer之中，buffer是固定大小，没有进行动态扩容，如果采用动态扩容要考虑到粘包问题，可以将报头固定，数据进行动态分配内存

​		4.网络层进行收发数据时要读取事件，可以将这一操作也放到线程池中，但是如果同一时间线程池处理某文件描述符，同时网络层再次收到这个文件描述符对应时间，可能处理不同事件，这是需要对处理时间加锁即可。